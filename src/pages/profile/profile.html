<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Movie Rating Extension</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../../shared/styles/common.css">
    <link rel="stylesheet" href="../../shared/styles/theme.css">
    <link rel="stylesheet" href="../../shared/styles/components.css">
    <link rel="stylesheet" href="../../shared/styles/navigation.css">
    <link rel="stylesheet" href="../../shared/styles/profile.css">
    
    <!-- Firebase -->
    <script src="../../../libs/firebase-app-compat.js"></script>
    <script src="../../../libs/firebase-auth-compat.js"></script>
    <script src="../../../libs/firebase-firestore-compat.js"></script>
    
    <!-- Services -->
    <script src="../../shared/firestore.js"></script>
    <script src="../../shared/config/kinopoisk.config.js"></script>
    <script src="../../shared/services/RatingsCacheService.js"></script>
    <script src="../../shared/services/RatingService.js"></script>
    <script src="../../shared/services/MovieCacheService.js"></script>
    <script src="../../shared/services/KinopoiskService.js"></script>
    <script src="../../shared/services/UserService.js"></script>
    <script src="../../shared/services/WatchlistService.js"></script>
    <script src="../../shared/services/FavoriteService.js"></script>
    <script src="../../shared/services/CollectionService.js"></script>
    <script src="../../shared/services/ImageCacheService.js"></script>
    <script src="../../shared/services/ProfileService.js"></script>
    <script src="../../shared/utils/Utils.js"></script>
    <script src="../../shared/utils/IconUtils.js"></script>
    <script src="../../shared/utils/Icons.js"></script>
    
    <!-- Components -->
    <script src="../../shared/components/Navigation.js"></script>
    <script src="../../shared/components/Router.js"></script>
</head>
<body>
    <!-- Navigation will be inserted here by Navigation.js -->
    
    <!-- Main Content -->
    <main class="profile-main">
        <div class="profile-container">
            <!-- Profile Header -->
            <div class="profile-header" id="profileHeader">
                <div class="profile-cover"></div>
                <div class="profile-content">
                    <div class="profile-photo" id="profilePhoto">
                        <img id="profilePhotoImg" src="" alt="Profile" style="display: none;">
                        <div class="profile-photo-placeholder" id="profilePhotoPlaceholder">
                            <span id="profileInitials">U</span>
                        </div>
                    </div>
                    <div class="profile-info">
                        <h1 class="profile-name primary-name" id="profileName">Loading...</h1>
                        <p class="profile-username secondary-name" id="profileUsername">username</p>
                        <p class="profile-bio" id="profileBio" style="display: none;"></p>
                        <div class="profile-meta" id="profileMeta">
                            <span class="meta-item" id="profileJoinDate" style="display: none;">
                                <span class="meta-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></span>
                                <span id="joinDateText"></span>
                            </span>
                            <span class="meta-item" id="profileFavoriteGenre" style="display: none;">
                                <span class="meta-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6c0-1.5 1-2 3-2s3 .5 3 2v14c0 1.5-1 2-3 2s-3-.5-3-2V6z"/><path d="M8 6v14"/><path d="M8 6c0-1.5 1-2 3-2s3 .5 3 2v14c0 1.5-1 2-3 2s-3-.5-3-2V6z"/><path d="M14 6v14"/><path d="M14 6c0-1.5 1-2 3-2s3 .5 3 2v14c0 1.5-1 2-3 2s-3-.5-3-2V6z"/></svg></span>
                                <span id="favoriteGenreText"></span>
                            </span>
                        </div>
                        <div class="profile-menu" id="profileMenu" style="display: none;">
                            <button class="btn-profile-menu" id="profileMenuBtn">
                                <span class="menu-icon">⋮</span>
                            </button>
                            <div class="profile-dropdown" id="profileDropdown">
                                <button class="dropdown-item" id="editProfileItem">
                                    <span class="dropdown-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></span>
                                    Edit Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="profile-stats" id="profileStats">
                <div class="stat-card">
                    <span class="stat-value" id="statTotalRatings">0</span>
                    <span class="stat-label">Movies Rated</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statAverageRating">0.0</span>
                    <span class="stat-label">Average Rating</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statFavorites">0</span>
                    <span class="stat-label">Favorites</span>
                </div>
                <div class="stat-card">
                    <span class="stat-value" id="statWatchlist">0</span>
                    <span class="stat-label">Watchlist</span>
                </div>
            </div>

            <!-- Recent Ratings Section -->
            <div class="recent-ratings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <span class="section-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg></span>
                        Recent Ratings
                    </h2>
                    <button class="btn-view-all" id="viewAllRatingsBtn">
                        View All
                    </button>
                </div>
                <div class="recent-ratings-list" id="recentRatingsList">
                    <div class="loading-spinner-small"></div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading-section" id="loadingSection">
                <div class="loading-spinner"></div>
                <p>Loading profile...</p>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <div class="error-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: #ef4444;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div>
                <h3 class="error-state-title">Something went wrong</h3>
                <p class="error-state-text" id="errorMessage">Failed to load profile</p>
                <button class="error-state-btn" id="retryBtn">Try Again</button>
            </div>
        </div>
    </main>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal" style="display: none;">
        <div class="modal-content edit-profile-modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span class="modal-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></span>
                    Edit Profile
                </h2>
                <button class="modal-close" id="editProfileModalClose">×</button>
            </div>
            <form id="editProfileForm" class="modal-body">
                <!-- Banner Upload -->
                <div class="form-group banner-upload">
                    <label>Profile Banner</label>
                    <div class="banner-upload-container">
                        <div class="banner-preview" id="bannerPreview">
                            <img id="bannerPreviewImg" src="" alt="Banner Preview" style="display: none;">
                            <div class="banner-placeholder" id="bannerPlaceholder">
                                <span class="banner-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></span>
                                <span>No Banner Selected</span>
                            </div>
                        </div>
                        <div class="banner-actions">
                            <label class="btn-upload" for="bannerInput">
                                <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></span>
                                Upload Banner
                            </label>
                            <input type="file" id="bannerInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display: none;">
                            <button type="button" class="btn-remove" id="removeBannerBtn" style="display: none;">
                                <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></span>
                                Remove
                            </button>
                        </div>
                    </div>
                    <p class="photo-hint">Recommended: 1200x400px · JPG/PNG/WEBP/GIF · max 5MB</p>
                </div>

                <!-- Photo Upload -->
                <div class="form-group photo-upload">
                    <label>Profile Photo</label>
                    <div class="photo-upload-container">
                        <div class="photo-preview" id="photoPreview">
                            <img id="photoPreviewImg" src="" alt="Preview" style="display: none;">
                            <div class="photo-placeholder" id="photoPlaceholder">
                                <span id="photoInitials">U</span>
                            </div>
                        </div>
                        <div class="photo-actions">
                            <label class="btn-upload" for="photoInput">
                                <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></span>
                                Upload Photo
                            </label>
                            <input type="file" id="photoInput" accept="image/png,image/jpeg,image/webp,image/gif" style="display: none;">
                            <button type="button" class="btn-remove" id="removePhotoBtn" style="display: none;">
                                <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></span>
                                Remove
                            </button>
                        </div>
                    </div>
                    <p class="photo-hint">JPG/PNG/WEBP/GIF · max 5MB</p>
                </div>

                <!-- First Name -->
                <div class="form-group">
                    <label for="firstNameInput">First Name *</label>
                    <input type="text" id="firstNameInput" name="firstName" maxlength="50" required>
                    <span class="error-message" id="firstNameError"></span>
                </div>

                <!-- Last Name -->
                <div class="form-group">
                    <label for="lastNameInput">Last Name *</label>
                    <input type="text" id="lastNameInput" name="lastName" maxlength="50" required>
                    <span class="error-message" id="lastNameError"></span>
                </div>

                <!-- Username -->
                <div class="form-group">
                    <label for="usernameInput">Username *</label>
                    <input type="text" id="usernameInput" name="username" minlength="3" maxlength="20" pattern="[a-zA-Z0-9_]+" required>
                    <span class="error-message" id="usernameError"></span>
                    <p class="input-hint">3-20 characters, letters, numbers, and underscores only</p>
                </div>

                <!-- Bio -->
                <div class="form-group">
                    <label for="bioInput">Bio / About Me</label>
                    <textarea id="bioInput" name="bio" rows="3" maxlength="200" placeholder="Tell us about yourself..."></textarea>
                    <div class="char-count">
                        <span id="bioCharCount">0</span>/200
                    </div>
                    <span class="error-message" id="bioError"></span>
                </div>

                <!-- Display Name Format -->
                <div class="form-group">
                    <label for="displayNameFormatInput">Display Name in Navigation</label>
                    <select id="displayNameFormatInput" name="displayNameFormat">
                        <option value="fullname">First Name + Last Name</option>
                        <option value="username">Username</option>
                    </select>
                    <p class="input-hint">Choose what to display in the navigation bar</p>
                </div>

                <!-- Favorite Genre -->
                <div class="form-group">
                    <label for="favoriteGenreInput">Favorite Genre</label>
                    <select id="favoriteGenreInput" name="favoriteGenre">
                        <option value="">Select genre...</option>
                        <option value="Action">Action</option>
                        <option value="Adventure">Adventure</option>
                        <option value="Animation">Animation</option>
                        <option value="Comedy">Comedy</option>
                        <option value="Crime">Crime</option>
                        <option value="Documentary">Documentary</option>
                        <option value="Drama">Drama</option>
                        <option value="Family">Family</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Horror">Horror</option>
                        <option value="Romance">Romance</option>
                        <option value="Sci-Fi">Sci-Fi</option>
                        <option value="Thriller">Thriller</option>
                    </select>
                </div>

                <!-- Social Links -->
                <div class="form-section">
                    <h3 class="form-section-title">Social Links (optional)</h3>
                    <div class="form-group">
                        <label for="twitterInput">Twitter</label>
                        <input type="url" id="twitterInput" name="twitter" placeholder="https://twitter.com/username">
                    </div>
                    <div class="form-group">
                        <label for="instagramInput">Instagram</label>
                        <input type="url" id="instagramInput" name="instagram" placeholder="https://instagram.com/username">
                    </div>
                    <div class="form-group">
                        <label for="facebookInput">Facebook</label>
                        <input type="url" id="facebookInput" name="facebook" placeholder="https://facebook.com/username">
                    </div>
                </div>

                <!-- Password Section (for email users) -->
                <div class="form-section" id="passwordSection" style="display: none;">
                    <h3 class="form-section-title">Change Password</h3>
                    <button type="button" class="btn-toggle-password" id="togglePasswordBtn">Change Password</button>
                    <div id="passwordFields" style="display: none;">
                        <div class="form-group">
                            <label for="currentPasswordInput">Current Password</label>
                            <input type="password" id="currentPasswordInput" name="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPasswordInput">New Password</label>
                            <input type="password" id="newPasswordInput" name="newPassword" minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPasswordInput">Confirm New Password</label>
                            <input type="password" id="confirmPasswordInput" name="confirmPassword" minlength="6">
                        </div>
                        <span class="error-message" id="passwordError"></span>
                    </div>
                </div>

            </form>
            <!-- Form Footer -->
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelEditBtn">Cancel</button>
                <button type="submit" form="editProfileForm" class="btn-primary" id="saveProfileBtn">
                    <span id="saveBtnText">Save Changes</span>
                    <span id="saveBtnLoading" style="display: none;">Saving...</span>
                </button>
            </div>
            <div id="profileToast" class="toast-message" style="display: none;"></div>
        </div>
    </div>

    <!-- Main Script -->
    <script src="profile.js"></script>
</body>
</html>


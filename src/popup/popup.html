<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Rating Extension</title>
    <link rel="stylesheet" href="../shared/styles/common.css">
    <link rel="stylesheet" href="../shared/styles/theme.css">
    <link rel="stylesheet" href="../shared/styles/components.css">
    <link rel="stylesheet" href="../shared/styles/navigation.css">
    <link rel="stylesheet" href="../shared/styles/popup.css">
    <link rel="stylesheet" href="../shared/styles/overflow-fixes.css">
</head>
<body>
    <script>
        (function() {
            const theme = localStorage.getItem('movieExtensionTheme') || 'dark';
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            }
        })();
    </script>
    <div class="popup-container">
        <!-- Update Banner -->
        <div id="updateBanner" class="update-banner" style="display: none;">
            <div class="update-content">
                <span class="update-icon">üöÄ</span>
                <div class="update-text">
                    <span class="update-title">Update Available</span>
                    <span class="update-version" id="updateVersion">New version ready</span>
                </div>
            </div>
            <div class="update-actions">
                <button id="updateBtn" class="btn-update">Update</button>
                <button id="dismissUpdateBtn" class="btn-dismiss">‚úï</button>
            </div>
        </div>

        <!-- Header -->
        <header class="popup-header">
            <h1 class="popup-title">Movie Ratings</h1>
            <div class="auth-status" id="authStatus">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">Not authenticated</span>
            </div>
        </header>

        <!-- Initial Loading -->
        <div class="initial-loading" id="initialLoading" style="display: flex; justify-content: center; align-items: center; padding: 60px 20px;">
            <div class="loading-spinner"></div>
        </div>

        <!-- Auth Section -->
        <div class="auth-section" id="authSection" style="display: none;">
            <div class="auth-container">
                <!-- Login Form -->
                <div id="loginFormSection" class="auth-content active">
                    <!-- Step 1 Elements -->
                    <div id="loginStep1">
                        <!-- Google Button -->
                        <button id="googleLoginBtn" class="btn btn-google">
                            <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20px" height="20px">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                            </svg>
                            <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google</span>
                        </button>

                        <div class="auth-divider"></div>

                        <form id="loginEmailForm" class="auth-form">
                            <div class="form-group">
                                <label for="loginEmail">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                                <input type="email" id="loginEmail" class="form-input" placeholder="–í–∞—à –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">–í–æ–π—Ç–∏</button>
                        </form>
                    </div>

                    <!-- Step 2 Elements (Initially Hidden) -->
                    <div id="loginStep2" style="display: none;">
                        <form id="loginPasswordForm" class="auth-form">
                            <div class="form-group">
                                <label>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                                <div id="staticEmail" class="static-input-text"></div>
                            </div>
                            <div class="form-group">
                                <div class="label-row">
                                    <label for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                                    <a href="#" class="forgot-password-link">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                                </div>
                                <div class="password-input-wrapper">
                                    <input type="password" id="loginPassword" class="form-input" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" required>
                                    <button type="button" class="toggle-password" title="Show password">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-gradient btn-block">–í–æ–π—Ç–∏</button>
                            
                            <div class="auth-switch back-nav">
                                <a href="#" id="backToEmailBtn">‚Üê –ù–∞–∑–∞–¥</a>
                            </div>
                        </form>
                    </div>
                    
                    <div id="loginFooter" class="auth-switch">
                         <p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" id="showRegisterLink">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></p>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="registerFormSection" class="auth-content" style="display: none;">
                    <!-- Step 1: Basic Info -->
                    <div id="registerStep1">
                         <!-- Google Button (Visible on Step 1) -->
                        <button id="googleRegisterBtn" class="btn btn-google">
                            <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20px" height="20px">
                                <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/>
                                <path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/>
                                <path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/>
                                <path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z"/>
                            </svg>
                            <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å Google</span>
                        </button>

                        <div class="auth-divider"></div>

                        <form id="registerInfoForm" class="auth-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="registerFirstName">–ò–º—è</label>
                                    <input type="text" id="registerFirstName" class="form-input" placeholder="–í–∞—à–µ –∏–º—è" required>
                                </div>
                                <div class="form-group">
                                    <label for="registerLastName">–§–∞–º–∏–ª–∏—è</label>
                                    <input type="text" id="registerLastName" class="form-input" placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="registerEmail">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                                <input type="email" id="registerEmail" class="form-input" placeholder="–í–∞—à –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                        </form>
                    </div>

                    <!-- Step 2: Password Creation -->
                    <div id="registerStep2" style="display: none;">
                        <form id="registerPasswordForm" class="auth-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>–ò–º—è</label>
                                    <div id="staticName" class="static-input-text"></div>
                                </div>
                                <div class="form-group">
                                    <label>–§–∞–º–∏–ª–∏—è</label>
                                    <div id="staticSurname" class="static-input-text"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
                                <div id="staticRegisterEmail" class="static-input-text"></div>
                            </div>

                            <div class="form-group">
                                <label for="registerPassword">–ü–∞—Ä–æ–ª—å</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="registerPassword" class="form-input" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" required minlength="6">
                                    <button type="button" class="toggle-password" title="Show password">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="registerConfirmPassword">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                                <div class="password-input-wrapper">
                                    <input type="password" id="registerConfirmPassword" class="form-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required minlength="6">
                                    <button type="button" class="toggle-password" title="Show password">üëÅÔ∏è</button>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-gradient btn-block">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>

                            <div class="auth-switch back-nav">
                                <a href="#" id="backToRegisterInfoBtn">‚Üê –ù–∞–∑–∞–¥</a>
                            </div>
                        </form>
                    </div>

                     <div id="registerFooter" class="auth-switch">
                        <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" id="showLoginLink">–í–æ–π—Ç–∏</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent" style="display: none;">
            <!-- User Actions -->
            <div class="user-actions">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar" style="display: none;">
                    <span id="userName">User</span>
                </div>
                <div class="feed-actions">
                    <button id="settingsBtn" class="btn btn-ghost btn-sm">Settings</button>
                    <button id="logoutBtn" class="btn btn-secondary btn-sm">Sign Out</button>
                </div>
            </div>
            
            <!-- Search Section -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search movies...">
                    <button id="searchIconBtn" class="search-icon">üîç</button>
                    <div id="searchResults" class="search-results" style="display: none;"></div>
                </div>
            </div>

            <!-- Feed Section -->
            <div class="feed-section">
                <div class="feed-header">
                    <h2 class="feed-title">Recent Ratings</h2>
                    <div class="feed-actions">
                        <button id="viewAllRatingsBtn" class="btn btn-primary btn-sm">View All Ratings</button>
                        <button id="refreshBtn" class="btn btn-ghost btn-sm">Refresh</button>
                    </div>
                </div>
                
                <div class="feed-content" id="feedContent">
                    <div class="empty-state">
                        <div class="empty-state-icon">üé¨</div>
                        <h3 class="empty-state-title">No ratings yet</h3>
                        <p class="empty-state-text">Start rating movies to see them here!</p>
                    </div>
                </div>
            </div>
            
            <!-- Loading overlay - moved outside feed-section to avoid overflow clipping -->
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <span>Loading...</span>
            </div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage" style="display: none;"></div>
    </div>

    <!-- Scripts -->
    <script src="../../libs/firebase-app-compat.js"></script>
    <script src="../../libs/firebase-firestore-compat.js"></script>
    <script src="../../libs/firebase-auth-compat.js"></script>
    <script src="../shared/config/kinopoisk.config.js"></script>
    <script src="../shared/services/KinopoiskService.js"></script>
    <script src="../shared/services/MovieCacheService.js"></script>
    <script src="../shared/services/RatingService.js"></script>
    <script src="../shared/services/RatingsCacheService.js"></script>
    <script src="../shared/services/UserService.js"></script>
    <script src="../shared/utils/helpers.js"></script>
    <script src="../shared/utils/Utils.js"></script>
    <script src="../shared/utils/IconUtils.js"></script>
    <script src="../shared/components/Navigation.js"></script>
    <script src="../shared/firestore.js"></script>
    <script src="popup.js"></script>
</body>
</html>
